<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="./common-styles.html">

<dom-module id="slr-form-modal">
  <template include="common-styles">
    <style include="common-styles">
      :host {
        display: block;
        @apply --slr-content;
        text-align: left;
        --paper-input-container-disabled: {
          opacity: 0.66;
        };
      }

      paper-dialog {
        max-width: var(--app-content-max-width);
        min-width: 500px;
      }

      app-toolbar {
        margin-top: 0;
        padding: 0 10px;
        background-color: var(--app-secondary-color);
      }

      paper-fab {
        margin-top: 60px;
        margin-right: 5%;
      }
    </style>

    <paper-dialog id="dialog" opened={{opened}}>

      <app-toolbar>
        <paper-icon-button icon="close" title="close" dialog-dismiss></paper-icon-button>
        <div main-title>{{title}}</div>
        <paper-fab mini icon="create" title="edit" on-click="toggleEditMode" hidden$="{{editMode}}"></paper-fab>
        <paper-button hidden$="{{!editMode}}" on-click="cancel">Cancel</paper-button>
        <paper-button dialog-confirm hidden$="{{!editMode}}" on-click="submitForm" autofocus>Save</paper-button>
      </app-toolbar>

      <p><slot></slot></p>

      <paper-dialog-scrollable>
        <iron-form id="form">
          <form method="{{method}}" action="{{action}}" class="form">
            <slot></slot>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

    </paper-dialog>
  </template>
  <script>
    class SlrFormModal extends Polymer.Element {
      static get is() { return 'slr-form-modal' }

      static get properties() {
        return {
          title: {
            type: String
          },
          item: {
            type: Object,
            notify: true,
            observer: 'itemChanged'
          },
          // save copy to avoid iron-form and paper-input issues
          _item: {
            type: Object
          },
          opened: {
            type: Boolean,
            value: false,
            notify: true
          },
          editMode: {
            type: Boolean,
            notify: true
          }
        }
      }

      static get observers() {
        return [ 'itemPropsChanged(item.slo, item.sli)' ]
      }

      ready() {
        super.ready();
        this.addEventListener('iron-overlay-opened', this.whenOpened)
        this.addEventListener('iron-overlay-closed', this.whenClosed)
      }

      whenOpened() {
        this.copyItem()
        this.reset()
        this.dispatchEvent(new CustomEvent('slr-form-modal-opened'));
      }

      whenClosed() {
        this.reset()
        this.set('editMode', false)
        this.dispatchEvent(new CustomEvent('slr-form-modal-closed'));
      }

      itemChanged() {
        this.copyItem()
      }

      itemPropsChanged(obj) {
        this.copyItem()
      }

      toggleEditMode() {
        this.set('editMode', !this.editMode)
      }

      cancel() {
        this.reset()
        this.set('editMode', false)
      }

      submitForm() {
        this.$.form.submit()
      }

      reset() {
        this.set('item', Object.assign({}, this._item))
      }

      copyItem() {
        this.set('_item', Object.assign({}, this.item))
      }

    }

    window.customElements.define(SlrFormModal.is, SlrFormModal)
  </script>
</dom-module>
